# Flask-RESTX tutorial

**Оглавление:**

1. [Установка Flask-RESTX в виртуальную среду](../01_virtual_environment/README.md)
2. [Первое приложение](../02_first_application/README.md)
3. [Создание и добавление ресурсов](../03_creating_resources/README.md)
4. [Парсинг данных запроса](../04_request_parsing/README.md)
5. Маршалинг и форматирование выходных данных

---

## 5. Маршалинг и форматирование выходных данных

По-умолчанию все возвращаемые из метода обработки поля 
передаются без изменений. Такое поведение хорошо работает 
с простыми структурами данных, например словарями, однако
может оказаться неудобным при работе с объектами класса.

Для описания модели выходных данных используется 
модуль, входящий в состав пакета `flask-restx`, под 
названием [Models](https://flask-restx.readthedocs.io/en/latest/api.html#models).
Типы значений, которые необходимы для описания полей 
модели находятся в файле `fields`.

Подключение необходимых модулей:
```python
from flask_restx import Model, fields
```

Для создания новой модели необходимо вызвать конструктор
класса `Model`, в качестве первого аргумента передается
публичное имя модели, которое отображается в документации 
Swagger, в качестве второго аргумента передается словарь, 
содержащий описание полей создаваемой модели:

```python
test_fields = Model(
    "Test model",
    {
        "id": fields.Integer(required=True),
        "name": fields.String(required=True, default="Default data")
    }
)
```

В `fields` доступны следующие типы с описанием их 
параметров:
* Raw — базовый тип от которого расширяются остальные 
  типы, поэтому содержит общие для всех типов параметры:
  * default — значение по-умолчанию, используется
    если значение не указано;
  * attribute — указать имя поля с которого берется 
    значение, используется если имена различаются;
  * title (str) — заголовок поля для документации;
  * description (str) — описание поля для документации;
  * required (bool) — если True, то поле обязательно
    для заполнения;
  * readonly (bool) — если True, то поле доступно 
    только для чтения, указывается для документации;
  * example — пример данных для документации;
  * mask — функция маски, применяемая к выводу.
* String — строка.
* FormattedString — форматированный вывод других полей
  обрабатываемых данный, имена подставляемых
  полей указываются в фигурных скобках:
  * src_str (str) — строка для форматирования.
* Url — строковое представление URL:
  * endpoint (str) — имя конечной точки, по-умолчанию
    установлено значение None при котором используется
    `request.endpoint`;
  * absolute (bool) — если True, то адрес содержит 
    имя хоста;
  * scheme (str) — спецификатор схемы url, 
    например http, https, ftp и другие.
* DateTime — форматированная строка даты и времени в 
  формате UTC:
  * dt_format (str) — формат ([rfc822](https://datatracker.ietf.org/doc/html/rfc822#section-5)
    или [iso8601](https://www.w3.org/TR/NOTE-datetime)). 
* Date — форматированная строка даты в формате 
  UTC в ISO 8601.
* Boolean — логического значение.
* Integer — целочисленное значение.
* Float — число с плавающей точкой в формате 
  [IEEE-754](https://datewiki.ru/wiki/IEEE_754).
* Arbitrary — число с плавающей запятой произвольной 
  точности.
* Fixed — десятичное число с фиксированной точностью:
  * decimals (int) — количество цифр.
* Nested — позволяет вкладывать другие наборы полей,
  подробнее [тут](https://flask-restplus.readthedocs.io/en/stable/marshalling.html#nested-field):
  * model (dict) — словарь для вложения; 
  * allow_null (bool) — если True, то возвращает значение
    None вместо словаря с нулевыми ключами, если во 
    вложенном словаре все нулевые ключи;
  * skip_none (bool) — если True, то исключает из вывода
  поля со значениями None.
* List — поле для создания списка на основе других 
  полей, в том числе и типа Nested:
  * cls_or_instance — тип поля, содержащего список.
* Wildcard — аналогичен List, но в качестве имени поля
  указывается маска, которая может содержать символы
  `*` и `?`.

Перед использованием созданной модели необходимо 
добавить ее в список доступных моделей, иначе 
документация Swagger не будет запускаться. Для этого 
необходимо добавить ее в специальный словарь:

```python
api.models[test_fields.name] = test_fields
```

Чтобы метод начал обрабатывать выходные данные согласно 
описанной модели, используется декоратор `marshal_with`:

```python
@api.route("/api/test")
class Tests(Resource): 
    @api.marshal_with(test_fields)
    def get(self):
        pass
```

Аргументы декоратора:
 * fields (dict) — описанная модель;
 * envelope (str) — название поля, куда попадут 
   обработанные с помощью модели данные;
 * skip_none (bool) — если True, то из ответа будут 
   исключены поля со значением None;
 * ordered (bool) — если True, то исходный порядок 
   сохраняется;
 * as_list (bool) — если True, то возвращает список в
   качестве результата;
 * code (int) — статус код возвращаемого значения,
   по-умолчанию равен 200;
 * description (str) — описание.

> Примечание: обработку данных можно сделать без 
> использования декоратора с помощью функции
> `marshal`, которая в качестве первого аргумента 
> принимает объект с данными, а вторым созданную модель.

---

Пример кода к данному параграфу доступен [тут](./main.py).
